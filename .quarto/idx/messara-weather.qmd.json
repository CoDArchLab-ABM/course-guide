{"title":"Importing time series: weather data","markdown":{"headingText":"Importing time series: weather data","headingAttr":{"id":"messara-weather","classes":[],"keyvalue":[]},"containsRefs":false,"markdown":"\nTo compromise model complexity and precision, we will regulate land productivity by combining flow accumulation with the Agricultural reference index of drought (ARID). We will calculate a time-series of ARID for each day-of-year and patch using a modified version of the Soil Water (sub)model, again in the [Indus Village model](https://github.com/Andros-Spica/indus-village-model) (Angourakis 2021). This submodel is a NetLogo implementation of the model defined by Wallach et al. 2019, which is based on Woli et al. 2012.\n\n> Wallach, Daniel, David Makowski, James W. Jones, and Francois Brun. 2019. Working with Dynamic Crop Models (Third Edition). Academic Press. https://doi.org/10.1016/C2016-0-01552-8.\n\n> Woli, Prem, James W. Jones, Keith T. Ingram, and Clyde W. Fraisse. 2012. ‘Agricultural Reference Index for Drought (ARID)’. Agronomy Journal 104 (2): 287. https://doi.org/10.2134/agronj2011.0286.\n\nTo calculate ARID, we will use a point sample of daily weather variables. The dataset metadata is as follows:\n\n*File name*: POWER_Point_Daily_19840101_20201231_035d0309N_024d8335E_LST.csv\n\n*Source*: NASA POWER (https://power.larc.nasa.gov/data-access-viewer/; see their sources and methodology at https://power.larc.nasa.gov/docs/methodology/)\n\n*Point location*: Petrokefali (LAT: 35.0309; LON: 24.8335) \n\n*Time extent*: 01/01/1984 - 31/12/2020\n\n*Variables*:\n- YEAR, MO, DY: year (number), month (index in year) and day (index in month) of observation/row\n- PRECTOTCORR: The bias corrected average of total precipitation at the surface of the earth in water mass (includes water content in snow).  \n- T2M_MIN, T2M_MAX: The maximum/minimum/average hourly air (dry bulb) temperature at 2 meters above the surface of the earth.  \n- ALLSKY_SFC_SW_DWN: The total solar irradiance incident (direct plus diffuse) on a horizontal plane at the surface of the earth under all sky conditions. An alternative term for the total solar irradiance is the \"Global Horizontal Irradiance\" or GHI.  \n\nBased on code from the Indus Village, we implement the first module only for loading, running, and displaying the dataset as simulation input data.\n\nThis module uses the data structure `list` to hold and process the data. The dataset is loaded from the original CSV file into several global variables (using the CSV NetLogo extension). You may need to look at NetLogo's Dictionary several times to understand every step in this procedure.\n\n```NetLogo\nextensions [ csv ]\n\nglobals\n[\n  ;;; weather input data\n  weatherInputData_firstYear\n  weatherInputData_lastYear\n  weatherInputData_YEARS\n  weatherInputData_yearLengthInDays\n  weatherInputData_DOY\n  weatherInputData_YEAR-DOY\n  weatherInputData_solarRadiation\n  weatherInputData_precipitation\n  weatherInputData_temperature\n  weatherInputData_maxTemperature\n  weatherInputData_minTemperature\n\n  ;;;; Solar radiation (MJ/m2)\n  solar_annualMax\n  solar_annualMin\n  solar_meanDailyFluctuation\n\n  ;;; variables\n  ;;;; time tracking\n  currentYear\n  currentDayOfYear\n\n  ;;;; main (these follow a seasonal pattern and apply for all patches)\n\n  T ; average temperature of current day (ºC)\n  T_max ; maximum temperature of current day (ºC)\n  T_min ; minimum temperature of current day (ºC)\n\n  solarRadiation ; solar radiation of current day (MJ m-2)\n\n  RAIN ; precipitation of current day (mm)\n  precipitation_yearSeries\n  precipitation_cumYearSeries\n]\n\n...\n\nto load-weather-input-data-table\n\n  ;;; this procedure loads the values of the weather data input table\n  ;;; the table contains:\n  ;;;   1. 13 lines of metadata, to be ignored\n  ;;;   2. one line with the headers of the table\n  ;;;   3. remaining rows containing row name and values\n\n  let weatherTable csv:from-file \"data/POWER_Point_Daily_19840101_20201231_035d0309N_024d8335E_LST.csv\"\n\n  ;;;==================================================================================================================\n  ;;; mapping coordinates (row or columns) from headings (line 14 == index 13 -----------------------------------------\n  ;;; NOTE: always correct raw mapping coordinates (start at 1) into list indexes (start at 0)\n  let variableNames item (14 - 1) weatherTable\n\n  let yearColumn position \"YEAR\" variableNames\n\n  let solarRadiationColumn position \"ALLSKY_SFC_SW_DWN\" variableNames\n\n  let precipitationColumn position \"PRECTOTCORR\" variableNames\n\n  let temperatureColumn position \"T2M\" variableNames\n\n  let temperatureMaxColumn position \"T2M_MAX\" variableNames\n\n  let temperatureMinColumn position \"T2M_MIN\" variableNames\n\n  ;;;==================================================================================================================\n  ;;; extract data---------------------------------------------------------------------------------------\n\n  ;;; read variables per year and day (list of lists, matrix: year-day x variables)\n  let weatherData sublist weatherTable (15 - 1) (length weatherTable) ; select only those row corresponding to variable data, if there is anything else\n\n  ;;; extract year-day of year pairs from the third and fourth columns\n  set weatherInputData_YEARS map [row -> item yearColumn row ] weatherData\n\n  ;;; NASA-POWER data uses year, month, day of month, instead of day of year,\n  ;;; so we need to calculate day of year of each row ourselves\n  set weatherInputData_DOY []\n  set weatherInputData_yearLengthInDays []\n  foreach (remove-duplicates weatherInputData_YEARS)\n  [\n    aYear ->\n    let aDoy 1\n    let lengthOfThisYear length (filter [i -> i = aYear] weatherInputData_YEARS)\n    set weatherInputData_yearLengthInDays lput lengthOfThisYear weatherInputData_yearLengthInDays\n    repeat lengthOfThisYear\n    [\n      set weatherInputData_DOY lput aDoy weatherInputData_DOY\n      set aDoy aDoy + 1\n    ]\n  ]\n  set weatherInputData_YEAR-DOY (map [[i j] -> (word i \"-\" j)] weatherInputData_YEARS weatherInputData_DOY)\n\n  ;;; extract first and last year\n  set weatherInputData_firstYear first weatherInputData_YEARS\n\n  set weatherInputData_lastYear last weatherInputData_YEARS\n\n  ;;; extract parameter values from the given column\n  ;;; NOTE: read-from-string is required because the original file is formated in a way that NetLogo interprets values as strings.\n\n  set weatherInputData_solarRadiation map [row -> item solarRadiationColumn row ] weatherData\n\n  set weatherInputData_precipitation map [row -> item precipitationColumn row ] weatherData\n\n  set weatherInputData_temperature map [row -> item temperatureColumn row ] weatherData\n\n  set weatherInputData_maxTemperature map [row -> item temperatureMaxColumn row ] weatherData\n\n  set weatherInputData_minTemperature map [row -> item temperatureMinColumn row ] weatherData\n\nend\n```\n\nThere are other ways of doing this in NetLogo and many possible variations within this specific approach. The most important things here are to make sure that variable names are intelligible and all references to the internal structure of the CSV file are kept updated if any changes are made directly to the file. Abundant comments are also welcomed in this type of procedure. \n\nThis module also introduces an aspect that may be relevant when inputting or generating time series: calendar time keeping. This may seem trivial, but it has often been a weak point in models relying on input data.\n\n```Netlogo\nto advance-time\n\n  set currentDayOfYear currentDayOfYear + 1\n  \n  if (currentDayOfYear > item (currentYear - weatherInputData_firstYear) weatherInputData_yearLengthInDays)\n  [\n    set currentYear currentYear + 1\n    set currentDayOfYear 1\n  ]\n\nend\n```\n\nPress \"setup\" and then \"go\" (continuous run). NetLogo will run until it reaches the last day of the last year included in the dataset. This is because we have added in `go` a stop condition.\n\n```NetLogo\nto go\n\n  advance-time\n  \n  ;;; values are taken from input data\n  set-day-weather-from-input-data currentDayOfYear currentYear\n\n  tick\n\n  ; --- stop conditions -------------------------\n  \n  if (currentYear = weatherInputData_lastYear and currentDayOfYear = last weatherInputData_yearLengthInDays) [stop]\n\nend\n```\n\n![Screenshot of the 'load-weather-data' module](assets/screenshots/BlockC_module3_load-weather-data interface.png)  \n*Screenshot of the 'load-weather-data' module*\n\nSee the fully implemented version of this module: `BlockC_module3_load-weather-data.nlogo`.\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"svg","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["assets/styles.css"],"output-file":"messara-weather.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.7.32","bibliography":["references.bib"],"comments":{"hypothesis":true},"theme":"lumen"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}