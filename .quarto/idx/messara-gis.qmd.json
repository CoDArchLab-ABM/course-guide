{"title":"Importing spatial data: elevation and site data","markdown":{"headingText":"Importing spatial data: elevation and site data","headingAttr":{"id":"messara-gis","classes":[],"keyvalue":[]},"containsRefs":false,"markdown":"\n## The `gis`extension\n\nThe NetLogo default installation includes an extension to support GIS that can be used by adding the following to the first section of your script:\n\n```NetLogo\nextensions [ gis ]\n```\n\nThis extension allows you to perform a variety of GIS operations and to connect patch and turtle behaviour to data expressed in GIS files, supporting both vector and raster. The description of its contents can be found here: https://ccl.northwestern.edu/netlogo/docs/gis.html\n\nWe will only reference a few aspects of GIS in NetLogo. You will find useful examples in NetLogo's Models Library (*e.g.*, Sample Models > Code Examples > Extensions Examples > gis > GIS General Examples).\n\n## Loading GIS data\n\nWe start by loading all GIS data into separate NetLogo variables. To know about the formats this extension accepts, see here: https://ccl.northwestern.edu/netlogo/docs/gis.html#gis:load-dataset. \n\n```NetLogo\nglobals\n[\n  ;;; GIS data holders\n  sitesData_EMIII-MMIA\n  sitesData_MMIB\n  elevationData\n  riversData\n]\n\n...\n\nto load-gis\n\n  ; Load all of our datasets\n  set sitesData_EMIII-MMIA gis:load-dataset \"data/Cretedata/EMIII_MMIAsites.shp\"\n  set sitesData_MMIB gis:load-dataset \"data/Cretedata/MMIBsites.shp\"\n\n  set elevationData gis:load-dataset \"data/Cretedata/dem15.asc\"\n  set riversData gis:load-dataset \"data/Cretedata/rivers.shp\"\n\n  ; Set the world envelope to the union of all of our dataset's envelopes\n  gis:set-world-envelope (gis:envelope-of elevationData)\n\nend\n```\n\nThe files in \"data/Cretedata/\" were distributed during our in-person session, courtesy of Dr Eleftheria Paliou (University of Cologne). Site coordinates were randomly shifted in QGIS to be published online after the session.\n\nWe are using:\n\n- Two shape files containing point coordinates of various archaeological sites in the region, corresponding to two aggregated periods (see [Minoan Chronology](https://en.wikipedia.org/wiki/Minoan_chronology)):  \n  - `EMIII_MMIAsites.shp`: sites dating from the Prepalatial Period, specifically the Early Minoan III (EMIII) and Middle Minoan IA (MMIA) Periods\n  - `MMIBsites.shp`: sites dating from the Protopalatial Period, specifically the Middle Minoan IB (MMIB) Period\n- A DEM raster file: `dem15.asc` (elevation of the terrain with a 15m resolution)\n- A third shape file, `rivers.shp`, contains line data with the rivers within the region.\n\n## Readjusting `world` settings\n\nThe second step is ensuring that our world and world view in NetLogo fits the data we want to feed into them. In this case, we need to reduce the DEM resolution to handle all patch processes in a reasonable computation time.\n\n```Netlogo\nglobals\n[\n  width\n  height\n\n  ;;; GIS data holders\n  sitesData_EMIII-MMIA\n  sitesData_MMIB\n  elevationData\n  riversData\n]\n\nto set-world-dimensions\n\n  ;;; for better performance, we take a multiple fraction of the dimensions of elevationData,\n  ;;; so that patches will get average values or more regular sets of pixels\n\n  let patchXpixelScale 0.1 ;;; keep it less than 0.25\n  let pixelExtentMargin 50\n\n  set width ceiling ((pixelExtentMargin + gis:width-of elevationData) * patchXpixelScale)\n  set height ceiling ((pixelExtentMargin + gis:height-of elevationData) * patchXpixelScale)\n\n  resize-world 0 width 0 height\n\n  set-patch-size 3\n\nend\n```\n\n## Applying GIS data to patches\n\nNext, we effectively apply the data to patches using the gis extension primitives:\n\n```NetLogo\nglobals\n[\n  patchesWithElevationData\n  noElevationDataTag\n  maxElevation\n\n  width\n  height\n\n  ;;; GIS data holders\n  sitesData_EMIII-MMIA\n  sitesData_MMIB\n  elevationData\n  riversData\n]\n\nbreed [ sites site ]\n\nsites-own\n[\n  name\n  siteType\n  period\n]\n\npatches-own\n[\n  elevation\n  isRiver\n]\n\nto setup-patches\n\n  setup-elevation\n\n  setup-rivers\n\nend\n\nto setup-elevation\n\n  gis:apply-raster elevationData elevation\n\n  set patchesWithElevationData patches with [(elevation <= 0) or (elevation >= 0)]\n  \n  ;;; replace NaN values added by the gis extension with noElevationDataTag, so it does not generate problems after\n  set noElevationDataTag -9999\n  ask patches with [not ((elevation <= 0) or (elevation >= 0))] [ set elevation noElevationDataTag ]\n\n  set maxElevation max [elevation] of patchesWithElevationData\n\nend\n\nto setup-rivers\n\n  ask patchesWithElevationData\n  [\n    set isRiver gis:intersects? riversData self\n  ]\n\nend\n\nto setup-sites\n\n  ;;; gis extension will re-use a site, if it was already created in a position,\n  ;;; and modify any values we already set.\n  ;;; In order to avoid this, we cannot use gis:create-turtles-from-points\n  \n  let datasetPeriod \"EMIII-MMIA\"\n  foreach gis:feature-list-of sitesData_EMIII-MMIA \n  [\n    vectorFeature ->\n    \n    create-site-from-feature vectorFeature datasetPeriod\n  ]\n  \n  set datasetPeriod \"MMIB\"\n  foreach gis:feature-list-of sitesData_MMIB \n  [\n    vectorFeature ->\n    \n    create-site-from-feature vectorFeature datasetPeriod\n  ]\n\nend\n\nto create-site-from-feature [ vectorFeature datasetPeriod ]\n  \n  let coordTuple gis:location-of (first (first (gis:vertex-lists-of vectorFeature)))\n  let featureName gis:property-value vectorFeature \"NAME\"\n  let featureType gis:property-value vectorFeature \"TYPE\"\n\n  let long item 0 coordTuple\n  let lat item 1 coordTuple\n\n  create-sites 1\n  [ \n    setxy long lat\n    set name featureName\n    set siteType featureType\n    set period datasetPeriod\n    \n    set shape \"dot\"\n  ]\n  \nend\n```\n\nNotice that the gis extension generates NaN values on those patches outside the raster data. NetLogo does not handle NaNs, which can become a problem later. To solve this, we create a patch-set variable to filter patches with elevation data (`patchesWithElevationData`) and use a constant `noElevationDataTag` with an impossible elevation value to mark those outside the heightmap. From now on, we need to be careful not to use the `patches` primitive, which will call both kinds of patches.\n\n## Higher level procedure: `create-map`\n\nWe wrap up everything in a procedure `create-map`:\n\n```NetLogo\nto create-map\n\n  load-gis  ;; load in the GIS data\n\n  set-world-dimensions ;; set world dimensions according to GIS data\n\n  setup-patches ;; use GIS data to set patch variables\n\n  setup-sites ;; create site agents with properties from sitesData\n\nend\n```\n\n## Visualisation\n\nFinally, we need to add some extra code in order to display our data: \n\n```NetLogo\nto update-display\n\n  display-rivers\n\n  display-sites\n\n  paint-elevation\n\nend\n\nto display-sites\n\n  ;;; sites dated to EMIII-MMIA: yellow\n  gis:set-drawing-color yellow\n  gis:draw sitesData_EMIII-MMIA 2\n\n  ;;; sites dated to MMIB: red\n  gis:set-drawing-color red\n  gis:draw sitesData_MMIB 2\n\n  ;;; sites dated to both EMIII-MMIA and MMIB: orange\n\nend\n\nto display-rivers\n\n  gis:set-drawing-color blue\n  gis:draw riversData 1\n\nend\n\nto paint-elevation\n\n  ;;; paint patches according to elevation\n  ;;; NOTE: we must filter out those patches outside the DEM\n  ask patchesWithElevationData\n  [\n    let elevationGradient 100 + (155 * (elevation / maxElevation))\n    set pcolor rgb (elevationGradient - 100) elevationGradient 0\n  ]\n\nend\n```\n\n## Set up procedure and testing\n\nWe then we place both in a higher-level procedure, using the conventional `setup` (and adding its button):\n\n```NetLogo\nto setup\n\n  clear-all\n\n  create-map\n\n  update-display\n\nend\n```\n\n![Screenshot of the 'load-gis-data' module](assets/screenshots/BlockC_module1_load-gis-data interface.png)  \n*Screenshot of the 'load-gis-data' module*\n\nSee the fully implemented version of this module: `BlockC_module1_load-gis-data.nlogo`.\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"svg","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["assets/styles.css"],"output-file":"messara-gis.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.7.32","bibliography":["references.bib"],"comments":{"hypothesis":true},"theme":"lumen"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}